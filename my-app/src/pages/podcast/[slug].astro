---
// Dynamic podcast episode page template
// Renders individual podcast episodes by slug from the podcast content collection
import { getCollection, getEntryBySlug } from 'astro:content';
import PodcastLayout from '../../layouts/PodcastLayout.astro';

// Generate static paths for all podcast episodes
export async function getStaticPaths() {
  const podcastEpisodes = await getCollection('podcast');

  return podcastEpisodes.map(episode => ({
    params: { slug: episode.slug },
    props: { episode },
  }));
}

// Type definition for the component props
interface Props {
  episode: Awaited<ReturnType<typeof getEntryBySlug<'podcast'>>>;
}

const { episode } = Astro.props;

// If somehow no episode is found, this shouldn't happen with static generation
if (!episode) {
  return Astro.redirect('/404');
}

// Extract the podcast data and render the markdown content (episode notes)
const { data, slug } = episode;
const { Content } = await episode.render();

// Format the episode publish date
const formattedDate = new Date(data.pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<PodcastLayout title={data.title} description={data.description}>
  <article class="max-w-3xl mx-auto px-4 py-8">
    {/* Episode header with metadata */}
    <header class="mb-8 border-b border-gray-200 pb-6">
      <div class="flex items-center gap-3 mb-3">
        <span class="inline-block px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold">
          Episode {data.episode}
        </span>
      </div>

      <h1 class="text-4xl font-bold mb-3">{data.title}</h1>

      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 mb-4">
        {/* Date and duration */}
        <div class="flex items-center gap-2">
          <time datetime={data.pubDate.toISOString()}>
            {formattedDate}
          </time>
          <span>•</span>
          <span>{data.duration}</span>
        </div>

        {/* Guest information if present */}
        {data.guests && data.guests.length > 0 && (
          <div class="flex items-center gap-2">
            <span>•</span>
            <span class="font-semibold">Guests: {data.guests.join(', ')}</span>
          </div>
        )}
      </div>

      {/* Tags if present */}
      {data.tags && data.tags.length > 0 && (
        <div class="flex gap-2 flex-wrap">
          {data.tags.map((tag: string) => (
            <span
              key={tag}
              class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium"
            >
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    {/* Audio player section */}
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 mb-8 border border-purple-200">
      <h2 class="text-lg font-semibold mb-4 text-gray-900">Listen to Episode</h2>

      {/* HTML5 audio player */}
      <audio
        controls
        class="w-full"
        preload="metadata"
      >
        <source src={data.audioUrl} type="audio/mpeg" />
        Your browser does not support the audio element. Please use the download link below.
      </audio>

      <p class="text-sm text-gray-600 mt-3">
        File size: {(data.fileSize / (1024 * 1024)).toFixed(2)} MB
      </p>
    </div>

    {/* Episode notes/description rendered from markdown */}
    <section class="mb-8">
      <h2 class="text-2xl font-bold mb-4">Episode Notes</h2>
      <div class="prose prose-sm sm:prose lg:prose-lg mx-auto max-w-none">
        <Content />
      </div>
    </section>

    {/* Transcript if available */}
    {data.transcript && (
      <section class="mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200">
        <h2 class="text-2xl font-bold mb-4">Transcript</h2>
        <div class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">
          {data.transcript}
        </div>
      </section>
    )}

    {/* Podcast metadata and links */}
    <footer class="mt-12 pt-8 border-t border-gray-200">
      <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
        <h3 class="text-lg font-semibold mb-4">Subscribe to the Podcast</h3>

        <div class="flex flex-wrap gap-3">
          <a
            href="#"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
          >
            Apple Podcasts
          </a>

          <a
            href="#"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
          >
            Spotify
          </a>

          <a
            href="/podcast-rss.xml"
            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm font-medium"
          >
            RSS Feed
          </a>
        </div>
      </div>
    </footer>
  </article>
</PodcastLayout>
